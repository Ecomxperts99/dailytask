<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoutineFlow - Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .dark-mode {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .light-mode {
            background-color: #f8fafc;
            color: #0f172a;
        }

        .custom-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .task-card {
            transition: all 0.2s ease;
        }

        .task-card:active {
            transform: scale(0.98);
        }

        .progress-bar-fill {
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body class="dark-mode min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-500"></div>
            <p class="text-slate-400 text-sm animate-pulse">Initializing Sync...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-10 backdrop-blur-md border-b border-slate-800 px-4 py-4" id="main-header">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-blue-600 rounded-lg">
                    <i data-lucide="check-circle-2" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="font-bold text-xl tracking-tight">RoutineFlow</h1>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full bg-slate-800 hover:bg-slate-700 transition-colors">
                <i data-lucide="sun" id="theme-icon" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6 pb-24">
        
        <!-- Date Selector -->
        <section class="p-4 rounded-2xl border border-slate-700 bg-slate-800/50" id="date-section">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium opacity-70 text-slate-400">Target Date</span>
                <i data-lucide="calendar" class="w-4 h-4 opacity-50"></i>
            </div>
            <input type="date" id="date-input" class="w-full bg-transparent text-lg font-semibold focus:outline-none cursor-pointer outline-none">
        </section>

        <!-- Stats Cards -->
        <section class="grid grid-cols-2 gap-4">
            <div class="p-4 rounded-2xl border border-slate-700 bg-slate-800/50" id="streak-card">
                <div class="flex items-center gap-2 mb-1 text-orange-500">
                    <i data-lucide="trophy" class="w-4 h-4"></i>
                    <span class="text-xs font-bold uppercase tracking-wider">Streak</span>
                </div>
                <div id="streak-value" class="text-2xl font-black">0 Days</div>
            </div>
            <div class="p-4 rounded-2xl border border-slate-700 bg-slate-800/50" id="perfect-card">
                <div class="flex items-center gap-2 mb-1 text-blue-500">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    <span class="text-xs font-bold uppercase tracking-wider">Perfect</span>
                </div>
                <div id="perfect-value" class="text-2xl font-black">0 Days</div>
            </div>
        </section>

        <!-- Progress Bar -->
        <section class="space-y-2">
            <div class="flex justify-between text-sm font-bold">
                <span>Daily Completion</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="h-3 w-full bg-slate-800 rounded-full overflow-hidden" id="progress-bg">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 progress-bar-fill" style="width: 0%"></div>
            </div>
        </section>

        <!-- Tasks List -->
        <section class="space-y-3">
            <h2 class="text-sm font-bold uppercase tracking-widest opacity-60 px-1">Today's Goals</h2>
            <div id="tasks-container" class="space-y-3">
                <!-- Tasks will be injected here -->
            </div>
        </section>

        <!-- WhatsApp Button -->
        <button id="whatsapp-btn" class="w-full flex items-center justify-center gap-2 py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-2xl font-bold shadow-lg shadow-emerald-900/20 transition-all active:scale-95">
            <i data-lucide="message-square" class="w-5 h-5"></i>
            Send Report to WhatsApp
        </button>

        <!-- History Preview -->
        <section class="space-y-3">
            <h2 class="text-sm font-bold uppercase tracking-widest opacity-60 px-1">History</h2>
            <div id="history-container" class="space-y-2">
                <!-- History items will be injected here -->
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 right-0 p-4 border-t border-slate-800 backdrop-blur-lg bg-slate-900/90" id="main-footer">
        <div class="max-w-md mx-auto text-center text-[10px] uppercase tracking-tighter opacity-40" id="user-display">
           Syncing data...
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'task-tracker-8127';
        const WHATSAPP_NUMBER = '8127202925';

        const FIXED_TASKS = [
            { id: 't1', label: 'Wake up at 8 AM', deadline: '08:00' },
            { id: 't2', label: 'Study minimum 4 hours till 4 PM', deadline: '16:00' },
            { id: 't3', label: 'Study minimum 4 hours till 10 PM', deadline: '22:00' },
            { id: 't4', label: 'Study minimum 2 hours till 2 AM', deadline: '02:00' },
        ];

        // --- State ---
        let currentUser = null;
        let darkMode = true;
        let selectedDate = new Date().toISOString().split('T')[0];
        let historyData = {};
        let tasksState = {};

        // --- Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const dateInput = document.getElementById('date-input');
        const tasksContainer = document.getElementById('tasks-container');
        const historyContainer = document.getElementById('history-container');
        const progressPercent = document.getElementById('progress-percent');
        const progressBar = document.getElementById('progress-bar');
        const streakValue = document.getElementById('streak-value');
        const perfectValue = document.getElementById('perfect-value');
        const whatsappBtn = document.getElementById('whatsapp-btn');
        const userDisplay = document.getElementById('user-display');

        // --- Initialization ---
        dateInput.value = selectedDate;

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
                // Even on error, hide loader so user can see UI
                loadingOverlay.classList.add('hidden');
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userDisplay.innerText = `User ID: ${user.uid} • Data Saved Automatically`;
                setupDataListeners();
                loadingOverlay.classList.add('hidden');
            }
        });

        // --- Data Listeners ---
        function setupDataListeners() {
            const historyRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'dailyTasks');
            onSnapshot(historyRef, (snapshot) => {
                historyData = {};
                snapshot.forEach(doc => {
                    historyData[doc.id] = doc.data();
                });
                updateUI();
            }, (error) => {
                console.error("Firestore error:", error);
            });
        }

        // --- Logic ---
        function updateUI() {
            const dayData = historyData[selectedDate] || {};
            tasksState = dayData.tasks || {};
            
            // Render Tasks
            tasksContainer.innerHTML = '';
            FIXED_TASKS.forEach(task => {
                const isDone = tasksState[task.id] || false;
                const card = document.createElement('div');
                card.className = `task-card group flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${
                    isDone 
                        ? (darkMode ? 'bg-blue-500/10 border-blue-500/50' : 'bg-blue-50 border-blue-200')
                        : (darkMode ? 'bg-slate-800 border-slate-700 hover:border-slate-500' : 'bg-white border-slate-200 hover:border-slate-300')
                }`;
                
                card.innerHTML = `
                    <div class="flex items-center gap-4 pointer-events-none">
                        <div class="transition-transform duration-300 ${isDone ? 'scale-110 text-blue-500' : 'text-slate-400'}">
                            <i data-lucide="${isDone ? 'check-circle-2' : 'circle'}" class="w-7 h-7"></i>
                        </div>
                        <div>
                            <p class="font-semibold transition-all ${isDone ? 'opacity-50 line-through' : ''}">
                                ${task.label}
                            </p>
                            <p class="text-xs opacity-50 font-medium">By ${task.deadline}</p>
                        </div>
                    </div>
                `;
                
                card.onclick = () => toggleTask(task.id);
                tasksContainer.appendChild(card);
            });

            // Calculate Progress
            const completedCount = Object.values(tasksState).filter(Boolean).length;
            const progress = Math.round((completedCount / FIXED_TASKS.length) * 100);
            progressPercent.innerText = `${progress}%`;
            progressBar.style.width = `${progress}%`;

            // Calculate Stats
            let streak = 0;
            let checkDate = new Date();
            while (true) {
                const key = checkDate.toISOString().split('T')[0];
                const data = historyData[key];
                const count = Object.values(data?.tasks || {}).filter(Boolean).length;
                if (count === FIXED_TASKS.length) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            streakValue.innerText = `${streak} Days`;
            
            const perfectDays = Object.values(historyData).filter(d => 
                Object.values(d.tasks || {}).filter(Boolean).length === FIXED_TASKS.length
            ).length;
            perfectValue.innerText = `${perfectDays} Days`;

            // Render History
            historyContainer.innerHTML = '';
            Object.keys(historyData).sort().reverse().slice(0, 5).forEach(dateKey => {
                const hTasks = historyData[dateKey].tasks || {};
                const hProgress = Math.round((Object.values(hTasks).filter(Boolean).length / FIXED_TASKS.length) * 100);
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-3 rounded-xl border ${darkMode ? 'bg-slate-800/30 border-slate-800' : 'bg-slate-100 border-slate-200 text-sm'}`;
                item.innerHTML = `
                    <span class="font-mono">${new Date(dateKey).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</span>
                    <div class="flex-1 mx-4 h-1.5 rounded-full bg-slate-700 overflow-hidden">
                        <div class="h-full bg-blue-500" style="width: ${hProgress}%"></div>
                    </div>
                    <span class="font-bold">${hProgress}%</span>
                `;
                historyContainer.appendChild(item);
            });

            lucide.createIcons();
        }

        async function toggleTask(taskId) {
            if (!currentUser) return;
            const newState = { ...tasksState, [taskId]: !tasksState[taskId] };
            
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'dailyTasks', selectedDate);
            await setDoc(docRef, {
                tasks: newState,
                updatedAt: new Date().toISOString(),
                date: selectedDate
            }, { merge: true });
        }

        // --- Event Listeners ---
        dateInput.onchange = (e) => {
            selectedDate = e.target.value;
            updateUI();
        };

        themeToggle.onclick = () => {
            darkMode = !darkMode;
            document.body.className = darkMode ? 'dark-mode min-h-screen' : 'light-mode min-h-screen';
            
            const sections = [document.getElementById('date-section'), document.getElementById('streak-card'), document.getElementById('perfect-card')];
            const header = document.getElementById('main-header');
            const footer = document.getElementById('main-footer');
            const progressBg = document.getElementById('progress-bg');

            if (darkMode) {
                sections.forEach(s => s.className = 'p-4 rounded-2xl border border-slate-700 bg-slate-800/50');
                header.className = 'sticky top-0 z-10 backdrop-blur-md border-b border-slate-800 bg-slate-900/80 px-4 py-4';
                footer.className = 'fixed bottom-0 left-0 right-0 p-4 border-t border-slate-800 backdrop-blur-lg bg-slate-900/90';
                progressBg.className = 'h-3 w-full bg-slate-800 rounded-full overflow-hidden';
                themeIcon.setAttribute('data-lucide', 'sun');
                themeToggle.className = 'p-2 rounded-full bg-slate-800 hover:bg-slate-700 transition-colors';
            } else {
                sections.forEach(s => s.className = 'p-4 rounded-2xl border border-slate-200 bg-white');
                header.className = 'sticky top-0 z-10 backdrop-blur-md border-b border-slate-200 bg-white/80 px-4 py-4';
                footer.className = 'fixed bottom-0 left-0 right-0 p-4 border-t border-slate-200 backdrop-blur-lg bg-white/90';
                progressBg.className = 'h-3 w-full bg-slate-200 rounded-full overflow-hidden';
                themeIcon.setAttribute('data-lucide', 'moon');
                themeToggle.className = 'p-2 rounded-full bg-slate-200 hover:bg-slate-300 transition-colors';
            }
            updateUI();
        };

        whatsappBtn.onclick = () => {
            const dateStr = new Date(selectedDate).toLocaleDateString('en-GB');
            let message = `*Daily Task Report*\nDate: ${dateStr}\n\n`;
            
            FIXED_TASKS.forEach(task => {
                const isDone = tasksState[task.id];
                message += `${isDone ? '✅' : '❌'} ${task.label} – ${isDone ? 'Completed' : 'Not Completed'}\n`;
            });

            const completionRate = Math.round((Object.values(tasksState).filter(Boolean).length / FIXED_TASKS.length) * 100);
            message += `\n*Daily Progress:* ${completionRate}%`;
            
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
        };

        // Initialize App
        initAuth();
        
        // Safety timeout to hide loader if auth hangs
        setTimeout(() => {
            loadingOverlay.classList.add('hidden');
            lucide.createIcons();
        }, 3000);
    </script>
</body>
</html>
